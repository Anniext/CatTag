# 蓝牙设备监控示例

这是一个使用 CatTag 蓝牙通信库开发的设备监控应用示例，演示了如何监控蓝牙设备的连接状态、信号强度和性能指标。

## 功能特性

- **实时设备发现**: 自动扫描和发现蓝牙设备
- **连接状态监控**: 实时监控设备连接状态
- **信号强度监测**: 显示设备 RSSI 信号强度
- **心跳检测**: 定期发送心跳包检测设备存活性
- **延迟测量**: 测量设备响应延迟
- **健康检查**: 综合评估设备连接健康状态
- **告警系统**: 设备异常时发送告警通知
- **统计信息**: 收集和显示连接统计数据
- **实时面板**: 动态更新的监控面板界面

## 快速开始

### 1. 编译应用

```bash
cd examples/device-monitor
go build -o device-monitor main.go
```

### 2. 启动监控器

```bash
./device-monitor -mode=monitor
```

### 3. 启动被监控设备

在其他设备上启动设备代理：

```bash
./device-monitor -mode=device
```

## 命令行参数

- `-mode`: 运行模式，可选 `monitor` 或 `device`（默认: monitor）
- `-service`: 蓝牙服务 UUID（默认: 11111111-2222-3333-4444-555555555555）
- `-scan-interval`: 设备扫描间隔（默认: 30s）
- `-ping-interval`: 心跳检测间隔（默认: 5s）
- `-log-level`: 日志级别，可选 `debug`, `info`, `warn`, `error`（默认: info）

## 应用命令

在应用界面中，您可以使用以下命令：

- `help` - 显示帮助信息
- `quit` 或 `exit` - 退出应用
- `list` - 列出所有监控设备的详细信息
- `status` - 显示系统状态和统计信息
- `connect <设备ID>` - 手动连接指定设备
- `disconnect <设备ID>` - 断开指定设备连接
- `ping <设备ID>` - 向指定设备发送心跳包
- `refresh` - 手动刷新设备列表
- `clear` - 清屏

## 使用示例

### 监控器启动示例

```bash
$ ./device-monitor -mode=monitor -scan-interval=15s -ping-interval=3s
=== CatTag 蓝牙设备监控应用 ===
模式: monitor
服务UUID: 11111111-2222-3333-4444-555555555555
扫描间隔: 15s
心跳间隔: 3s
输入 'help' 查看帮助信息
输入 'quit' 退出应用
==================================
[系统] 设备监控器已启动
[系统] 监控服务已启动，开始扫描设备...
```

### 监控面板显示

```
=== CatTag 蓝牙设备监控面板 ===
时间: 2024-01-15 14:30:25
监控设备数: 3
在线: 2, 离线: 1, 连接中: 0
================================
设备ID          | 名称           | 状态      | RSSI | 延迟    | 最后活动
----------------|----------------|-----------|------|---------|------------------
device_001      | 智能手机       | online    | -45  | 12.3ms  | 14:30:23
device_002      | 蓝牙耳机       | online    | -52  | 8.7ms   | 14:30:24
device_003      | 智能手表       | offline   | -78  | 0.0ms   | 14:29:45
================================
命令: list, status, connect <ID>, disconnect <ID>, ping <ID>, refresh, clear, quit
```

### 设备代理启动示例

```bash
$ ./device-monitor -mode=device
=== CatTag 蓝牙设备监控应用 ===
模式: device
服务UUID: 11111111-2222-3333-4444-555555555555
扫描间隔: 30s
心跳间隔: 5s
输入 'help' 查看帮助信息
输入 'quit' 退出应用
==================================
[系统] 设备代理已启动
[系统] 设备代理已就绪，等待监控器连接...
[连接] 新设备连接: monitor_001
```

### 设备列表详情

```bash
> list
=== 监控设备列表 (3) ===
设备ID: device_001
  名称: 智能手机
  状态: online
  RSSI: -45 dBm
  延迟: 12.345ms
  最后活动: 2024-01-15 14:30:23
  错误计数: 0
---
设备ID: device_002
  名称: 蓝牙耳机
  状态: online
  RSSI: -52 dBm
  延迟: 8.765ms
  最后活动: 2024-01-15 14:30:24
  错误计数: 1
  告警: 连接健康状态异常
---
设备ID: device_003
  名称: 智能手表
  状态: offline
  RSSI: -78 dBm
  延迟: 0s
  最后活动: 2024-01-15 14:29:45
  错误计数: 3
  告警: 设备离线, 连接失败: timeout
========================
```

## 技术实现

### 监控消息结构

```go
type MonitorMessage struct {
    ID        string                 `json:"id"`         // 消息ID
    Type      string                 `json:"type"`       // 消息类型
    DeviceID  string                 `json:"device_id"`  // 设备ID
    Data      map[string]interface{} `json:"data"`       // 监控数据
    Timestamp time.Time              `json:"timestamp"`  // 时间戳
}
```

### 设备状态结构

```go
type DeviceStatus struct {
    Device           bluetooth.Device  // 设备信息
    Connection       bluetooth.Connection // 连接对象
    IsConnected      bool             // 连接状态
    LastSeen         time.Time        // 最后发现时间
    LastPing         time.Time        // 最后心跳时间
    LastPong         time.Time        // 最后响应时间
    RSSI             int              // 信号强度
    Latency          time.Duration    // 延迟
    PacketLoss       float64          // 丢包率
    ConnectionTime   time.Time        // 连接建立时间
    BytesSent        int64            // 发送字节数
    BytesReceived    int64            // 接收字节数
    MessagesSent     int64            // 发送消息数
    MessagesReceived int64            // 接收消息数
    ErrorCount       int64            // 错误计数
    Status           string           // 状态标识
    Alerts           []string         // 告警列表
}
```

### 核心组件

1. **设备扫描器**: 定期扫描蓝牙设备
2. **连接管理器**: 管理设备连接和断开
3. **心跳监控器**: 发送心跳包检测设备存活性
4. **健康检查器**: 综合评估设备健康状态
5. **告警系统**: 检测异常并发送告警
6. **统计收集器**: 收集和分析连接统计数据
7. **显示面板**: 实时更新监控信息

### 监控流程

#### 监控器模式

1. 启动蓝牙服务端监听连接
2. 定期扫描发现新设备
3. 自动连接到发现的设备
4. 发送心跳包检测设备存活性
5. 收集和分析设备状态数据
6. 实时更新监控面板显示
7. 检测异常并发送告警

#### 设备代理模式

1. 启动蓝牙服务端等待连接
2. 响应监控器的心跳请求
3. 定期报告设备状态信息
4. 处理监控器的控制命令

## 监控指标

### 连接指标

- **连接状态**: online, offline, connecting, error
- **连接时长**: 设备连接持续时间
- **连接稳定性**: 连接中断次数和频率

### 性能指标

- **信号强度**: RSSI 值（dBm）
- **延迟**: 心跳包往返时间
- **丢包率**: 心跳包丢失比例
- **吞吐量**: 数据传输速率

### 健康指标

- **响应性**: 设备响应心跳的及时性
- **可用性**: 设备在线时间比例
- **错误率**: 通信错误发生频率

## 告警规则

### 连接告警

- 设备离线超过阈值时间
- 连接建立失败
- 连接意外中断

### 性能告警

- 信号强度低于阈值（如 -80 dBm）
- 延迟超过阈值（如 100ms）
- 丢包率超过阈值（如 10%）

### 健康告警

- 心跳响应超时
- 连续错误次数超过阈值
- 设备状态异常

## 配置优化

### 扫描间隔调优

```bash
# 快速发现模式（高功耗）
./device-monitor -scan-interval=10s

# 标准模式（平衡）
./device-monitor -scan-interval=30s

# 节能模式（低功耗）
./device-monitor -scan-interval=60s
```

### 心跳间隔调优

```bash
# 高频监控（高精度）
./device-monitor -ping-interval=2s

# 标准监控（平衡）
./device-monitor -ping-interval=5s

# 低频监控（节能）
./device-monitor -ping-interval=10s
```

## 扩展功能

您可以基于此示例扩展以下功能：

- **历史数据存储**: 将监控数据存储到数据库
- **图表可视化**: 生成信号强度和延迟趋势图
- **告警通知**: 通过邮件或短信发送告警
- **设备分组**: 按类型或位置对设备分组
- **阈值配置**: 可配置的告警阈值
- **远程控制**: 远程控制被监控设备
- **性能分析**: 深入的性能分析和报告
- **Web 界面**: 基于 Web 的监控面板

## 故障排除

### 常见问题

1. **设备发现失败**: 检查蓝牙是否启用，设备是否可发现
2. **连接超时**: 检查设备距离和信号强度
3. **心跳超时**: 检查网络连接质量
4. **高延迟**: 检查设备负载和蓝牙干扰
5. **频繁断线**: 检查电源管理和设备兼容性

### 调试技巧

1. **启用调试日志**:

   ```bash
   ./device-monitor -log-level=debug
   ```

2. **调整监控频率**:

   ```bash
   ./device-monitor -scan-interval=10s -ping-interval=2s
   ```

3. **查看详细状态**:

   ```bash
   > status
   > list
   ```

4. **手动测试连接**:
   ```bash
   > connect device_001
   > ping device_001
   ```

## 性能考虑

### 资源使用

- **CPU 使用**: 扫描和心跳检测会消耗 CPU 资源
- **内存使用**: 设备状态数据会占用内存
- **网络带宽**: 心跳包会消耗蓝牙带宽
- **电池消耗**: 频繁扫描会增加电池消耗

### 优化建议

- 根据实际需求调整扫描和心跳间隔
- 对离线设备减少监控频率
- 使用设备过滤减少不必要的连接
- 实现智能休眠机制

## 注意事项

- 此示例使用模拟蓝牙适配器，实际使用需要真实蓝牙硬件
- 监控大量设备时注意性能和资源消耗
- 某些操作系统可能需要管理员权限
- 蓝牙版本和协议兼容性可能影响监控效果
- 建议在生产环境中添加更完善的错误处理和恢复机制
