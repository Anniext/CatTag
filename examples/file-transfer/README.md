# 蓝牙文件传输示例

这是一个使用 CatTag 蓝牙通信库开发的文件传输应用示例，演示了如何通过蓝牙连接进行文件传输，包括大文件的分块传输和进度显示。

## 功能特性

- **双模式支持**: 支持服务端和客户端模式
- **分块传输**: 支持大文件的分块传输
- **进度显示**: 实时显示传输进度
- **文件校验**: MD5 校验确保文件完整性
- **断点续传**: 支持重复分块的处理
- **传输统计**: 显示传输速度和时间统计
- **多文件支持**: 支持连续传输多个文件
- **错误处理**: 完善的错误处理和重试机制

## 快速开始

### 1. 编译应用

```bash
cd examples/file-transfer
go build -o file-transfer main.go
```

### 2. 启动服务端（接收方）

```bash
./file-transfer -mode=server -download="./received_files"
```

### 3. 启动客户端（发送方）

在另一个终端或设备上：

```bash
./file-transfer -mode=client -download="./downloads"
```

## 命令行参数

- `-mode`: 运行模式，可选 `server` 或 `client`（默认: server）
- `-service`: 蓝牙服务 UUID（默认: 87654321-4321-4321-4321-210987654321）
- `-download`: 下载目录（默认: ./downloads）
- `-chunk-size`: 分块大小，单位字节（默认: 1024）
- `-log-level`: 日志级别，可选 `debug`, `info`, `warn`, `error`（默认: info）

## 应用命令

在应用界面中，您可以使用以下命令：

- `/help` - 显示帮助信息
- `/quit` 或 `/exit` - 退出应用
- `/status` - 显示连接状态和配置信息
- `/transfers` - 显示传输历史和当前状态
- `/send <文件路径>` - 发送指定文件（客户端模式）
- `/clear` - 清屏

在客户端模式下，也可以直接输入文件路径来发送文件。

## 使用示例

### 服务端启动示例

```bash
$ ./file-transfer -mode=server -download="./received_files"
=== CatTag 蓝牙文件传输应用 ===
模式: server
服务UUID: 87654321-4321-4321-4321-210987654321
下载目录: ./received_files
分块大小: 1024 字节
输入 '/help' 查看帮助信息
输入 '/quit' 退出应用
==================================
[系统] 文件传输服务端已启动，等待客户端连接...
[系统] 文件传输服务已就绪，可以接收文件
```

### 客户端连接和发送文件示例

```bash
$ ./file-transfer -mode=client
=== CatTag 蓝牙文件传输应用 ===
模式: client
服务UUID: 87654321-4321-4321-4321-210987654321
下载目录: ./downloads
分块大小: 1024 字节
输入 '/help' 查看帮助信息
输入 '/quit' 退出应用
==================================
[系统] 文件传输客户端已启动，正在搜索服务端...
[系统] 发现 1 个设备:
  1. 文件服务器 (device_001)
[系统] 正在连接到 文件服务器...
[系统] 已连接到 文件服务器，可以开始传输文件

# 发送文件
/send document.pdf
[系统] 开始发送文件: document.pdf (245.67 KB, 246 分块)
[发送] document.pdf: 100.0% (246/246 分块)
[系统] 文件发送完成: document.pdf
```

### 接收文件示例

```bash
# 在服务端看到的输出
[系统] 新设备连接: client_device_001
[系统] 接收文件信息: document.pdf (245.67 KB)
[系统] 开始接收文件: document.pdf
[传输] document.pdf: 100.0% (246/246 分块)
[系统] 文件接收完成: document.pdf
[系统] 文件已保存: ./received_files/document.pdf
[统计] 传输时间: 12.34s, 平均速度: 19.91 KB/s
```

## 技术实现

### 消息结构

```go
type FileTransferMessage struct {
    ID          string            `json:"id"`           // 消息ID
    Type        string            `json:"type"`         // 消息类型
    FileName    string            `json:"file_name"`    // 文件名
    FileSize    int64             `json:"file_size"`    // 文件大小
    ChunkIndex  int               `json:"chunk_index"`  // 分块索引
    TotalChunks int               `json:"total_chunks"` // 总分块数
    Data        []byte            `json:"data"`         // 数据内容
    Checksum    string            `json:"checksum"`     // MD5校验和
    Metadata    map[string]string `json:"metadata"`     // 元数据
    Timestamp   time.Time         `json:"timestamp"`    // 时间戳
}
```

### 传输协议

1. **文件信息阶段**: 发送方发送文件元信息（文件名、大小、校验和等）
2. **确认阶段**: 接收方确认准备就绪
3. **分块传输阶段**: 发送方按序发送文件分块
4. **确认阶段**: 接收方确认每个分块的接收
5. **完成阶段**: 接收方验证文件完整性并确认传输完成

### 核心组件

1. **文件分块器**: 将大文件分割成小块进行传输
2. **进度跟踪器**: 实时跟踪传输进度
3. **校验器**: 使用 MD5 校验文件完整性
4. **传输管理器**: 管理多个并发传输会话
5. **错误处理器**: 处理传输错误和重试逻辑

### 工作流程

#### 发送方（客户端）

1. 读取文件并计算 MD5 校验和
2. 将文件分割成指定大小的分块
3. 发送文件信息给接收方
4. 等待接收方确认准备就绪
5. 按序发送所有文件分块
6. 等待传输完成确认

#### 接收方（服务端）

1. 接收文件信息并创建传输会话
2. 发送准备就绪确认
3. 接收并重组文件分块
4. 验证文件完整性（MD5 校验）
5. 保存文件到指定目录
6. 发送传输完成确认

## 性能优化

### 分块大小调优

不同的分块大小会影响传输性能：

- **小分块（512-1024 字节）**: 适合不稳定的连接，错误恢复快
- **中等分块（2048-4096 字节）**: 平衡性能和稳定性
- **大分块（8192 字节以上）**: 适合稳定连接，传输效率高

```bash
# 使用不同分块大小
./file-transfer -chunk-size=512   # 小分块
./file-transfer -chunk-size=2048  # 中等分块
./file-transfer -chunk-size=8192  # 大分块
```

### 并发传输

应用支持多个文件的并发传输，每个文件使用独立的传输会话。

## 安全考虑

- **文件校验**: 使用 MD5 校验和验证文件完整性
- **路径安全**: 防止目录遍历攻击
- **大小限制**: 可以设置文件大小限制
- **类型过滤**: 可以限制允许传输的文件类型

## 扩展功能

您可以基于此示例扩展以下功能：

- **压缩传输**: 在传输前压缩文件
- **加密传输**: 对文件内容进行加密
- **断点续传**: 支持中断后继续传输
- **批量传输**: 支持文件夹和多文件选择
- **传输队列**: 支持传输任务队列管理
- **带宽控制**: 限制传输速度
- **传输历史**: 持久化传输记录
- **文件预览**: 传输前预览文件信息

## 故障排除

### 常见问题

1. **传输中断**: 检查蓝牙连接稳定性和设备距离
2. **文件校验失败**: 可能是传输过程中数据损坏，重新传输
3. **权限错误**: 确保有文件读写权限
4. **内存不足**: 对于大文件，考虑减小分块大小
5. **连接超时**: 增加连接超时时间或检查设备兼容性

### 调试模式

使用调试模式获取详细的传输日志：

```bash
./file-transfer -mode=server -log-level=debug
```

### 性能监控

使用 `/status` 和 `/transfers` 命令监控传输性能：

```bash
/status     # 查看连接状态
/transfers  # 查看传输历史和统计
```

## 注意事项

- 此示例使用模拟蓝牙适配器，实际使用需要真实蓝牙硬件
- 大文件传输可能需要较长时间，请保持设备连接稳定
- 传输过程中避免设备休眠或断开蓝牙连接
- 建议在传输重要文件前先测试小文件传输

## 技术规格

- **支持的文件大小**: 理论上无限制（受内存限制）
- **分块大小范围**: 256 字节 - 64KB
- **校验算法**: MD5
- **并发传输**: 支持多文件并发
- **错误恢复**: 自动重试机制
- **传输协议**: 基于 CatTag 蓝牙通信协议
