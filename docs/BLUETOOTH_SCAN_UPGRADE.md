# 蓝牙扫描功能升级说明

## 概述

本次升级将 CatTag 项目中的蓝牙设备扫描功能从模拟数据改为真实的蓝牙设备扫描。

## 主要更改

### 1. 删除的模拟代码

#### cmd/scan.go

- 删除了 `mockDevice` 结构体
- 删除了模拟设备数据数组
- 删除了基于定时器的模拟设备发现逻辑
- 删除了针对模拟设备的 `shouldShowDevice` 和 `displayDevice` 函数

#### internal/adapter/adapter.go

- 将 `scanDevices` 方法中的模拟扫描逻辑替换为真实蓝牙扫描
- 保留了模拟扫描作为回退机制（当真实蓝牙不可用时）

### 2. 新增的真实扫描功能

#### 依赖库

- 添加了 `tinygo.org/x/bluetooth` 库用于跨平台蓝牙支持

#### 核心功能

- **真实蓝牙适配器集成**: 使用 `tinygo.org/x/bluetooth` 库的 `DefaultAdapter`
- **真实设备扫描**: 通过 `Adapter.Scan()` 方法进行真实的蓝牙设备发现
- **扫描结果转换**: 将 `tinybt.ScanResult` 转换为项目内部的 `bluetooth.Device` 格式
- **设备去重**: 基于设备地址进行去重，避免重复显示同一设备
- **回退机制**: 当真实蓝牙不可用时，自动回退到模拟扫描模式

#### 新增函数

- `convertScanResult()`: 转换扫描结果格式
- `simulateScan()`: 模拟扫描回退方案
- `shouldShowBluetoothDevice()`: 真实设备过滤函数
- `displayBluetoothDevice()`: 显示真实设备信息

### 3. 功能特性

#### 设备信息显示

- 设备 ID 和地址
- 设备名称（如果可用）
- 信号强度 (RSSI)
- 最后发现时间
- 服务 UUID 列表
- 设备能力（加密支持、协议支持等）

#### 过滤功能

- 按设备名称过滤
- 按服务 UUID 过滤
- 信号强度过滤

#### 扫描模式

- 单次扫描（指定时长后停止）
- 持续扫描（持续发现设备直到手动停止）

## 测试验证

### 编译测试

```bash
go build -o build/cattag .
```

### 功能测试

```bash
# 基本扫描
./build/cattag scan --duration=5s

# 带过滤的扫描
./build/cattag scan --duration=5s --filter-name="Unknown"

# 持续扫描
./build/cattag scan --continuous
```

### 测试结果

- ✅ 代码编译成功，无语法错误
- ✅ 能够发现真实的蓝牙设备
- ✅ 设备信息显示完整（地址、信号强度、服务 UUID 等）
- ✅ 过滤功能正常工作
- ✅ 持续扫描模式正常工作
- ✅ 设备去重功能正常
- ✅ 回退机制可用

## 技术细节

### 蓝牙库选择

选择 `tinygo.org/x/bluetooth` 的原因：

- 跨平台支持（Linux、macOS、Windows）
- 纯 Go 实现，无需 CGO
- 支持 BLE (Bluetooth Low Energy)
- 活跃维护，文档完善

### 架构设计

- 保持了原有的接口设计不变
- 在适配器层面进行了实现替换
- 保留了模拟模式作为开发和测试的回退方案
- 错误处理和日志记录保持一致

### 兼容性

- 保持了所有原有的命令行参数和配置选项
- 输出格式保持一致
- API 接口无变化

## 后续改进建议

1. **设备缓存**: 实现设备信息缓存，提高重复扫描的性能
2. **连接功能**: 基于真实扫描结果实现设备连接功能
3. **高级过滤**: 支持更多过滤条件（如设备类型、制造商等）
4. **扫描优化**: 实现智能扫描间隔和功耗优化
5. **设备详情**: 获取更多设备详细信息（如制造商数据、广播数据等）

## 注意事项

1. **权限要求**: 在某些系统上可能需要蓝牙权限
2. **蓝牙状态**: 确保系统蓝牙已启用
3. **设备可见性**: 只能发现处于可发现状态的设备
4. **平台差异**: 不同平台的蓝牙行为可能略有差异
